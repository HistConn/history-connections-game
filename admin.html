<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - History Connections</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display+SC:wght@700&family=Roboto:wght@400;500&display=swap');
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .admin-container {
            background: #fff;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-width: 900px;
            width: 100%;
        }

        h1, h2 {
            font-family: 'Playfair Display SC', serif;
            text-align: center;
            color: #2E3C46;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        h2 {
            font-size: 1.8rem;
            margin-top: 30px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0d9cf;
            padding-bottom: 10px;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        .input-group label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #555;
        }

        .input-group input, .input-group select {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #A57336;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
        }

        .group-form {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #eee;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s;
            background-color: #A57336;
            color: white;
            margin-top: 20px;
        }

        .btn:hover {
            background-color: #8C5A2D;
        }

        #message {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
            display: none;
        }

        #message.success {
            background: #d4edda;
            color: #155724;
        }

        #message.error {
            background: #f8d7da;
            color: #721c24;
        }

    </style>
</head>
<body>

    <div class="admin-container" id="admin-container" style="display: none;">
        <h1>Admin Panel</h1>
        
        <div class="form-section">
            <div class="input-group">
                <label for="puzzle-date">Select Puzzle Date</label>
                <input type="date" id="puzzle-date">
            </div>
             <div class="input-group">
                <label for="puzzle-number">Puzzle Number</label>
                <input type="number" id="puzzle-number" placeholder="e.g., 2">
            </div>
        </div>

        <h2>Puzzle Words (16 total)</h2>
        <div class="form-section grid" id="words-grid">
            <!-- Word inputs will be generated by JS -->
        </div>

        <h2>Group Details</h2>
        <form id="puzzle-form">
            <div class="grid">
                <!-- Group forms will be generated by JS -->
            </div>
            <button type="submit" class="btn">Save Puzzle</button>
        </form>

        <div id="message"></div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration (should match your main game's config) ---
        const firebaseConfig = {
            apiKey: "AIzaSyC9bcjwfS5Td28Z0dFfEdDaVwTiBI0FHM4",
            authDomain: "history-connections-6c6e3.firebaseapp.com",
            projectId: "history-connections-6c6e3",
            storageBucket: "history-connections-6c6e3.firebasestorage.app",
            messagingSenderId: "818831139109",
            appId: "1:818831139109:web:db945934d3e2e39dd07acc",
            measurementId: "G-W4XX10J2T8"
        };
        const appId = firebaseConfig.projectId;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Simple Password Protection ---
        function authenticate() {
            const password = prompt("Enter admin password:", "");
            if (password === "history") {
                document.getElementById("admin-container").style.display = "block";
            } else {
                alert("Incorrect password.");
                document.body.innerHTML = "<h1>Access Denied</h1>";
            }
        }

        // --- UI Generation ---
        function generateForms() {
            const wordsGrid = document.getElementById('words-grid');
            for (let i = 1; i <= 16; i++) {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'input-group';
                inputGroup.innerHTML = `
                    <label for="word-${i}">Word ${i}</label>
                    <input type="text" id="word-${i}" required>
                `;
                wordsGrid.appendChild(inputGroup);
            }

            const groupsGrid = document.querySelector('#puzzle-form .grid');
            const difficulties = ['yellow', 'green', 'blue', 'purple'];
            for (let i = 1; i <= 4; i++) {
                const groupForm = document.createElement('div');
                groupForm.className = 'group-form';
                groupForm.innerHTML = `
                    <h3>Group ${i}</h3>
                    <div class="input-group">
                        <label for="group-category-${i}">Category Name</label>
                        <input type="text" id="group-category-${i}" required>
                    </div>
                    <div class="input-group">
                        <label>Words (enter the 4 words for this group)</label>
                        <input type="text" class="group-word" data-group="${i}" required>
                        <input type="text" class="group-word" data-group="${i}" required>
                        <input type="text" class="group-word" data-group="${i}" required>
                        <input type="text" class="group-word" data-group="${i}" required>
                    </div>
                    <div class="input-group">
                        <label for="group-difficulty-${i}">Difficulty</label>
                        <select id="group-difficulty-${i}">
                            ${difficulties.map(d => `<option value="${d}">${d.charAt(0).toUpperCase() + d.slice(1)}</option>`).join('')}
                        </select>
                    </div>
                `;
                groupsGrid.appendChild(groupForm);
            }
        }

        // --- Data Handling ---
        const puzzleForm = document.getElementById('puzzle-form');
        puzzleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const dateInput = document.getElementById('puzzle-date');
            if (!dateInput.value) {
                showMessage('Please select a date.', 'error');
                return;
            }
            const dateString = dateInput.value;

            // Collect all 16 words from the top grid
            const allWords = [];
            for (let i = 1; i <= 16; i++) {
                const word = document.getElementById(`word-${i}`).value.trim().toUpperCase();
                if (word) {
                    allWords.push(word);
                }
            }

            if (allWords.length !== 16) {
                showMessage('Please fill out all 16 word fields.', 'error');
                return;
            }

            // Collect group data
            const groups = [];
            for (let i = 1; i <= 4; i++) {
                const category = document.getElementById(`group-category-${i}`).value.trim();
                const difficulty = document.getElementById(`group-difficulty-${i}`).value;
                const groupWords = [];
                document.querySelectorAll(`.group-word[data-group="${i}"]`).forEach(input => {
                    const word = input.value.trim().toUpperCase();
                    if(word) groupWords.push(word);
                });

                if (!category || groupWords.length !== 4) {
                    showMessage(`Group ${i} is incomplete.`, 'error');
                    return;
                }
                
                groups.push({
                    category,
                    difficulty,
                    words: groupWords,
                });
            }

            // Construct the final puzzle object
            const puzzleData = {
                puzzleNumber: parseInt(document.getElementById('puzzle-number').value, 10) || 0,
                words: allWords,
                groups: groups,
            };

            // Save to Firestore
            try {
                const puzzleDocRef = doc(db, `/artifacts/${appId}/public/data/puzzles`, dateString);
                await setDoc(puzzleDocRef, puzzleData);
                showMessage('Puzzle saved successfully!', 'success');
                puzzleForm.reset();
                document.getElementById('words-grid').querySelectorAll('input').forEach(i => i.value = '');

            } catch (error) {
                console.error("Error saving puzzle:", error);
                showMessage('Error saving puzzle. See console for details.', 'error');
            }
        });

        // --- Fetch existing data on date change ---
        document.getElementById('puzzle-date').addEventListener('change', async (e) => {
            const dateString = e.target.value;
            if (!dateString) return;

            const puzzleDocRef = doc(db, `/artifacts/${appId}/public/data/puzzles`, dateString);
            const puzzleDocSnap = await getDoc(puzzleDocRef);

            if (puzzleDocSnap.exists()) {
                const data = puzzleDocSnap.data();
                // Populate the form with existing data
                document.getElementById('puzzle-number').value = data.puzzleNumber || '';
                
                data.words.forEach((word, index) => {
                    document.getElementById(`word-${index + 1}`).value = word;
                });

                data.groups.forEach((group, index) => {
                    const i = index + 1;
                    document.getElementById(`group-category-${i}`).value = group.category;
                    document.getElementById(`group-difficulty-${i}`).value = group.difficulty;
                    const wordInputs = document.querySelectorAll(`.group-word[data-group="${i}"]`);
                    group.words.forEach((word, wordIndex) => {
                        wordInputs[wordIndex].value = word;
                    });
                });
                showMessage('Loaded existing puzzle for this date.', 'success');
            } else {
                 // Clear the form if no data exists
                puzzleForm.reset();
                 document.getElementById('words-grid').querySelectorAll('input').forEach(i => i.value = '');
                 document.getElementById('puzzle-number').value = '';
                showMessage('No puzzle found for this date. Ready to create a new one.', 'success');
            }
        });


        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = type;
            messageEl.style.display = 'block';
        }

        // --- Initial Load ---
        authenticate();
        generateForms();

    </script>
</body>
</html>
